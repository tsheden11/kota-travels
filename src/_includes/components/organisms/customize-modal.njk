{% from "components/atoms/input.njk" import input %}
{% from "components/atoms/dropdown.njk" import dropdown %}
{% from "components/atoms/button.njk" import button %}

<div class="customize-modal" id="customizeModal" aria-modal="true" role="dialog" aria-labelledby="customizeModalTitle" aria-hidden="true">

  <div class="customize-modal__backdrop"></div>

  <div class="customize-modal__container">

    <button class="customize-modal__close" aria-label="Close modal">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <form class="customize-form" name="customize" method="POST" data-netlify="true" novalidate>
      <input type="hidden" name="form-name" value="customize" />

      <div class="customize-form__heading">
        <h2 class="customize-form__title" id="customizeModalTitle">Let's Design Your Journey</h2>
        <p class="customize-form__subtitle">We'll get back to you within 24 hours.</p>
      </div>

      <div class="customize-form__row">
        {{ input(name="fullName", label="Full Name", required=true, placeholder="Full Name") }}
        {{ input(name="email", label="Email", required=true, type="email", placeholder="Email") }}
      </div>

      <div class="customize-form__row">
        {{ input(name="phone", label="Phone Number", required=true, type="tel", placeholder="+00 000 000 0000") }}
        {{ input(name="travelers", label="Number of Travelers", required=true, type="number", placeholder="1") }}
      </div>

      <div class="customize-form__dates">
        <div class="customize-form__dates-label-row">
          <span class="customize-form__dates-label">Preferred Travel Dates</span>
          <span class="customize-form__required" aria-hidden="true">*</span>
        </div>
        <div class="customize-form__row">
          {{ input(name="dateFrom", label="From", required=true, type="date") }}
          {{ input(name="dateTo", label="To", required=true, type="date") }}
        </div>
      </div>

      <div class="customize-form__experiences">
        <div class="customize-form__label-row">
          <span class="customize-form__label">What experiences are you interested in?</span>
          <span class="customize-form__required" aria-hidden="true">*</span>
        </div>
        <div class="customize-form__checkbox-grid">
          <label class="customize-form__checkbox-item">
            <input type="checkbox" name="experiences" value="cultural" class="customize-form__checkbox-input" />
            <span class="customize-form__checkbox-box">
              <svg class="customize-form__checkbox-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                <rect x="2" y="2" width="16" height="16" rx="3" stroke="currentColor" stroke-width="2"/>
                <path class="customize-form__check-mark" d="M5 10l4 4 6-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="customize-form__checkbox-label">Cultural</span>
          </label>
          <label class="customize-form__checkbox-item">
            <input type="checkbox" name="experiences" value="wellness" class="customize-form__checkbox-input" />
            <span class="customize-form__checkbox-box">
              <svg class="customize-form__checkbox-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                <rect x="2" y="2" width="16" height="16" rx="3" stroke="currentColor" stroke-width="2"/>
                <path class="customize-form__check-mark" d="M5 10l4 4 6-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="customize-form__checkbox-label">Wellness</span>
          </label>
          <label class="customize-form__checkbox-item">
            <input type="checkbox" name="experiences" value="cycling" class="customize-form__checkbox-input" />
            <span class="customize-form__checkbox-box">
              <svg class="customize-form__checkbox-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                <rect x="2" y="2" width="16" height="16" rx="3" stroke="currentColor" stroke-width="2"/>
                <path class="customize-form__check-mark" d="M5 10l4 4 6-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="customize-form__checkbox-label">Cycling</span>
          </label>
          <label class="customize-form__checkbox-item">
            <input type="checkbox" name="experiences" value="trekking" class="customize-form__checkbox-input" />
            <span class="customize-form__checkbox-box">
              <svg class="customize-form__checkbox-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                <rect x="2" y="2" width="16" height="16" rx="3" stroke="currentColor" stroke-width="2"/>
                <path class="customize-form__check-mark" d="M5 10l4 4 6-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="customize-form__checkbox-label">Trekking</span>
          </label>
        </div>
      </div>

      {{ input(name="message", label="Questions, preferences, special requests - anything you'd like us to know.", required=true, type="textarea", placeholder="Places you'd love to visit, special occasions, trip length, accommodation preferences, accessibility or dietary needs, or anything else you'd like to share.", rows=165) }}

      {{ dropdown(name="referral", label="How did you hear about us?", required=true, options=[
        { value: "", label: "Please Select" },
        { value: "google", label: "Google Search" },
        { value: "instagram", label: "Instagram" },
        { value: "facebook", label: "Facebook" },
        { value: "friend", label: "Friend or Family" },
        { value: "other", label: "Other" }
      ]) }}

      {{ button(text="Submit", variant="primary", size="lg", type="submit", fullWidth=true) }}

    </form>

  </div>
</div>

<script>
  (function () {
    const modal    = document.getElementById('customizeModal');
    const backdrop = modal?.querySelector('.customize-modal__backdrop');
    const closeBtn = modal?.querySelector('.customize-modal__close');
    const form     = modal?.querySelector('.customize-form');

    if (!modal) return;

    document.querySelectorAll('[data-open-modal="customize"]').forEach(function (el) {
      el.addEventListener('click', function (e) {
        e.preventDefault();
        openModal();
      });
    });

    function openModal() {
      modal.setAttribute('aria-hidden', 'false');
      modal.classList.add('customize-modal--open');
      document.body.style.overflow = 'hidden';
      setTimeout(function () { modal.querySelector('input')?.focus(); }, 100);
    }

    function closeModal() {
      modal.setAttribute('aria-hidden', 'true');
      modal.classList.remove('customize-modal--open');
      document.body.style.overflow = '';
    }

    closeBtn?.addEventListener('click', closeModal);
    backdrop?.addEventListener('click', closeModal);
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && modal.classList.contains('customize-modal--open')) closeModal();
    });

    if (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        let valid = true;
        form.querySelectorAll('input[required]:not([type="checkbox"]), select[required], textarea[required]').forEach(function (field) {
          const wrapper = field.closest('.input-field, .dropdown-field');
          if (!field.value.trim()) {
            valid = false;
            wrapper?.classList.add('input-field--error');
          } else {
            wrapper?.classList.remove('input-field--error');
          }
        });
        const checked = form.querySelectorAll('input[name="experiences"]:checked');
        const grid = form.querySelector('.customize-form__checkbox-grid');
        if (checked.length === 0) {
          valid = false;
          grid?.classList.add('customize-form__checkbox-grid--error');
        } else {
          grid?.classList.remove('customize-form__checkbox-grid--error');
        }
        if (valid) form.submit();
      });
      form.querySelectorAll('input, select, textarea').forEach(function (field) {
        field.addEventListener('input', function () {
          field.closest('.input-field, .dropdown-field')?.classList.remove('input-field--error');
        });
      });
      form.querySelectorAll('.customize-form__checkbox-input').forEach(function (cb) {
        cb.addEventListener('change', function () {
          form.querySelector('.customize-form__checkbox-grid')?.classList.remove('customize-form__checkbox-grid--error');
        });
      });
    }
  })();
</script>