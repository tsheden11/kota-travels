{# =============================================================
   Book This Tour Modal - book-modal.njk

   Usage: Include once in base.njk (before </body>).
   Trigger: Any element with:
     data-open-modal="book"
     data-package-title="A Glimpse Of Bhutan"
     data-package-duration="7 Days / 6 Nights"

   Figma specs:
     Form card:   7951333px, padding: 60px, gap: 30px
                  bg: #FFFFFF, border-radius: 30px
     Title:       Outfit 600 40px/50px, #23C9A9 - heading-2
     Tour banner: bg #FFF6ED, border-radius: 10px, padding: 20px
                  Icon: 4444px gradient circle
                  Tour name: subtitle-2 600 24px, gradient text
                  Duration: body-2 400 20px, gradient text
     Submit btn:  "Book Now", full width, gradient
============================================================= #}

{% from "components/atoms/input.njk" import input %}
{% from "components/atoms/dropdown.njk" import dropdown %}
{% from "components/atoms/button.njk" import button %}

<div class="book-modal" id="bookModal" aria-modal="true" role="dialog" aria-labelledby="bookModalTitle" aria-hidden="true">

  <div class="book-modal__backdrop"></div>

  <div class="book-modal__container">

    {# Close button #}
    <button class="book-modal__close" aria-label="Close modal">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <form
      class="book-form"
      name="book-tour"
      method="POST"
      data-netlify="true"
      novalidate
    >
      <input type="hidden" name="form-name" value="book-tour" />
      <input type="hidden" name="packageTitle" id="bookFormPackageTitle" value="" />

      {#  HEADING  #}
      <div class="book-form__heading">
        <h2 class="book-form__title" id="bookModalTitle">Book Your Bhutan Journey</h2>
        <p class="book-form__subtitle">We'll get back to you within 24 hours.</p>
      </div>

      {#  TOUR INFO BANNER  #}
      <div class="book-form__banner">
        <div class="book-form__banner-icon" aria-hidden="true">
          <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 21l1.65-3.8a9 9 0 1 1 3.4 2.9L3 21"/>
          </svg>
        </div>
        <div class="book-form__banner-content">
          <span class="book-form__banner-title" id="bookBannerTitle">Tour Name</span>
          <span class="book-form__banner-duration" id="bookBannerDuration">Duration</span>
        </div>
      </div>

      {#  ROW 1: Full Name + Email  #}
      <div class="book-form__row">
        {{ input({
          name: "fullName",
          label: "Full Name",
          required: true,
          placeholder: "Full Name"
        }) }}
        {{ input({
          name: "email",
          label: "Email",
          required: true,
          type: "email",
          placeholder: "Email"
        }) }}
      </div>

      {#  ROW 2: Phone + Number of Travelers  #}
      <div class="book-form__row">
        {{ input({
          name: "phone",
          label: "Phone Number",
          required: true,
          type: "tel",
          placeholder: "+00 000 000 0000"
        }) }}
        {{ input({
          name: "travelers",
          label: "Number of Travelers",
          required: true,
          type: "number",
          placeholder: "1"
        }) }}
      </div>

      {#  PREFERRED DEPARTURE DATE - single date  #}
      {{ input({
        name: "departureDate",
        label: "Preferred Departure Date",
        required: true,
        type: "date"
      }) }}

      {#  ACCOMMODATION PREFERENCE - dropdown  #}
      {{ dropdown({
        name: "accommodation",
        label: "Accommodation Preference",
        required: true,
        options: [
          { value: "", label: "Please Select" },
          { value: "standard", label: "Standard (3-Star Hotels)" },
          { value: "boutique", label: "Boutique Hotels" },
          { value: "luxury", label: "Luxury Hotels" },
          { value: "homestay", label: "Homestay / Farmhouse" },
          { value: "mixed", label: "Mix of Hotels + Homestay" }
        ]
      }) }}

      {#  DIETARY REQUIREMENTS - optional  #}
      {{ input({
        name: "dietary",
        label: "Dietary Requirements (If Any)",
        required: false,
        placeholder: "Allergies or dietary restrictions"
      }) }}

      {#  QUESTIONS / MESSAGE - optional  #}
      {{ input({
        name: "message",
        label: "Questions, preferences, special requests - anything you'd like us to know.",
        required: false,
        type: "textarea",
        placeholder: "Places you'd love to visit, special occasions, trip length, accommodation preferences, accessibility or dietary needs, or anything else you'd like to share.",
        rows: 165
      }) }}

      {#  HOW DID YOU HEAR ABOUT US  #}
      {{ dropdown({
        name: "referral",
        label: "How did you hear about us?",
        required: true,
        options: [
          { value: "", label: "Please Select" },
          { value: "google", label: "Google Search" },
          { value: "instagram", label: "Instagram" },
          { value: "facebook", label: "Facebook" },
          { value: "friend", label: "Friend or Family" },
          { value: "other", label: "Other" }
        ]
      }) }}

      {#  SUBMIT  #}
      {{ button({
        text: "Book Now",
        variant: "primary",
        size: "lg",
        type: "submit",
        fullWidth: true
      }) }}

    </form>

  </div>
</div>

{#  MODAL JS  #}
<script>
  (function () {
    const modal    = document.getElementById('bookModal');
    const backdrop = modal?.querySelector('.book-modal__backdrop');
    const closeBtn = modal?.querySelector('.book-modal__close');
    const form     = modal?.querySelector('.book-form');
    const bannerTitle    = document.getElementById('bookBannerTitle');
    const bannerDuration = document.getElementById('bookBannerDuration');
    const hiddenTitle    = document.getElementById('bookFormPackageTitle');

    if (!modal) return;

    // Open triggers - any element with data-open-modal="book"
    document.querySelectorAll('[data-open-modal="book"]').forEach(function (el) {
      el.addEventListener('click', function (e) {
        e.preventDefault();

        // Populate banner from data attributes on the trigger element
        var title    = el.getAttribute('data-package-title') || '';
        var duration = el.getAttribute('data-package-duration') || '';

        if (bannerTitle)    bannerTitle.textContent    = title;
        if (bannerDuration) bannerDuration.textContent = duration;
        if (hiddenTitle)    hiddenTitle.value          = title;

        openModal();
      });
    });

    function openModal() {
      modal.setAttribute('aria-hidden', 'false');
      modal.classList.add('book-modal--open');
      document.body.style.overflow = 'hidden';
      setTimeout(function () {
        modal.querySelector('input')?.focus();
      }, 100);
    }

    function closeModal() {
      modal.setAttribute('aria-hidden', 'true');
      modal.classList.remove('book-modal--open');
      document.body.style.overflow = '';
    }

    closeBtn?.addEventListener('click', closeModal);
    backdrop?.addEventListener('click', closeModal);

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && modal.classList.contains('book-modal--open')) {
        closeModal();
      }
    });

    // Form validation - only required fields
    if (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var valid = true;

        form.querySelectorAll('input[required]:not([type="hidden"]), select[required], textarea[required]').forEach(function (field) {
          var wrapper = field.closest('.input-field, .dropdown-field');
          if (!field.value.trim()) {
            valid = false;
            wrapper?.classList.add('input-field--error');
          } else {
            wrapper?.classList.remove('input-field--error');
          }
        });

        if (valid) form.submit();
      });

      form.querySelectorAll('input, select, textarea').forEach(function (field) {
        field.addEventListener('input', function () {
          field.closest('.input-field, .dropdown-field')?.classList.remove('input-field--error');
        });
      });
    }

  })();
</script>