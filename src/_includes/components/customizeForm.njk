<!-- Trip Planning Popup Modal -->
<div id="tripPlannerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-gradient-to-r from-yellow-500 to-orange-500 p-6 rounded-t-2xl">
      <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-white">Plan Your Bhutan Journey</h2>
        <button id="closeModalBtn" class="text-white hover:text-gray-200 text-3xl font-bold leading-none">&times;</button>
      </div>
      <p class="text-white text-sm mt-2">Tell us about your dream trip and we'll create a perfect itinerary for you</p>
    </div>

    <form id="tripPlannerForm" class="p-6 space-y-5">
      <!-- Name and Email Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="tripName" class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
          <input type="text" id="tripName" name="tripName" required
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all">
        </div>
        <div>
          <label for="tripEmail" class="block text-sm font-semibold text-gray-700 mb-2">Email Address *</label>
          <input type="email" id="tripEmail" name="tripEmail" required
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all">
        </div>
      </div>

      <!-- Phone and Departure Date Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="tripPhone" class="block text-sm font-semibold text-gray-700 mb-2">Phone Number (WhatsApp) *</label>
          <input type="tel" id="tripPhone" name="tripPhone" required
                 placeholder="+975 or +66..."
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all">
        </div>
        <div>
          <label for="departureDate" class="block text-sm font-semibold text-gray-700 mb-2">Preferred Departure Date *</label>
          <input type="date" id="departureDate" name="departureDate" required
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all">
        </div>
      </div>

      <!-- Visited Before -->
      <div>
        <label for="visitedBefore" class="block text-sm font-semibold text-gray-700 mb-2">Have you visited Bhutan before? *</label>
        <select id="visitedBefore" name="visitedBefore" required
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all">
          <option value="">Select...</option>
          <option value="Yes, I've been to Bhutan">Yes, I've been to Bhutan</option>
          <option value="No, this is my first time">No, this is my first time</option>
        </select>
      </div>

      <!-- What Interests You -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-3">What interests you the most? * (Select all that apply)</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-yellow-50 cursor-pointer transition-all">
            <input type="checkbox" name="interests" value="Cultural tours & monasteries" class="w-4 h-4 text-yellow-500 focus:ring-yellow-500 rounded">
            <span class="text-sm text-gray-700">Cultural tours & monasteries</span>
          </label>
          <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-yellow-50 cursor-pointer transition-all">
            <input type="checkbox" name="interests" value="Mountain biking" class="w-4 h-4 text-yellow-500 focus:ring-yellow-500 rounded">
            <span class="text-sm text-gray-700">Mountain biking</span>
          </label>
          <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-yellow-50 cursor-pointer transition-all">
            <input type="checkbox" name="interests" value="Trekking & hiking" class="w-4 h-4 text-yellow-500 focus:ring-yellow-500 rounded">
            <span class="text-sm text-gray-700">Trekking & hiking</span>
          </label>
          <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-yellow-50 cursor-pointer transition-all">
            <input type="checkbox" name="interests" value="Wellness & relaxation" class="w-4 h-4 text-yellow-500 focus:ring-yellow-500 rounded">
            <span class="text-sm text-gray-700">Wellness & relaxation</span>
          </label>
          <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-yellow-50 cursor-pointer transition-all">
            <input type="checkbox" name="interests" value="Festival experiences" class="w-4 h-4 text-yellow-500 focus:ring-yellow-500 rounded">
            <span class="text-sm text-gray-700">Festival experiences</span>
          </label>
          <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-yellow-50 cursor-pointer transition-all">
            <input type="checkbox" name="interests" value="Photography tours" class="w-4 h-4 text-yellow-500 focus:ring-yellow-500 rounded">
            <span class="text-sm text-gray-700">Photography tours</span>
          </label>
        </div>
      </div>

      <!-- Additional Info -->
      <div>
        <label for="additionalInfo" class="block text-sm font-semibold text-gray-700 mb-2">Anything else we should know? *</label>
        <textarea id="additionalInfo" name="additionalInfo" rows="4" required
                  placeholder="Tell us about group size, special requests, budget range, specific interests..."
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all"></textarea>
      </div>

      <!-- How Did You Hear -->
      <div>
        <label for="howDidYouHear" class="block text-sm font-semibold text-gray-700 mb-2">How did you hear about us? *</label>
        <select id="howDidYouHear" name="howDidYouHear" required
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all">
          <option value="">Select...</option>
          <option value="Google Search">Google Search</option>
          <option value="Instagram">Instagram</option>
          <option value="Facebook">Facebook</option>
          <option value="Friend/Family Referral">Friend/Family Referral</option>
          <option value="Travel Blog/Website">Travel Blog/Website</option>
          <option value="TripAdvisor">TripAdvisor</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <!-- Submit Button -->
      <button type="submit" id="tripSubmitBtn"
              class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105">
        Submit My Trip Request
      </button>

      <div id="tripFormMessage" class="hidden text-center p-4 rounded-lg"></div>
    </form>
  </div>
</div>

<!-- Trip Planner Script -->
<script>
  // Only initialize once
  if (!window.tripPlannerInitialized) {
    window.tripPlannerInitialized = true;

    // Google Apps Script Web App URL
    const TRIP_PLANNER_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzAqubLL_SBXgKlNjNNR4uoFfSYssomiEo_vO9-AWUbhzEXpMnY36fFYqJNrbs1fYcLPg/exec';

    // Get modal elements
    const modal = document.getElementById('tripPlannerModal');
    const closeBtn = document.getElementById('closeModalBtn');

    // Function to open modal
    function openModal() {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Function to close modal
    function closeModal() {
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Listen for clicks on any element with 'open-trip-planner' class
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('open-trip-planner') || e.target.closest('.open-trip-planner')) {
        e.preventDefault();
        openModal();
      }
    });

    // Close button
    closeBtn.addEventListener('click', closeModal);

    // Close on outside click
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Form submission
    document.getElementById('tripPlannerForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('tripSubmitBtn');
      const formMessage = document.getElementById('tripFormMessage');
      const originalBtnText = submitBtn.innerHTML;

      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.innerHTML = '✈️ Submitting...';

      // Get checkbox values
      const interestsCheckboxes = document.querySelectorAll('input[name="interests"]:checked');
      const interests = Array.from(interestsCheckboxes).map(cb => cb.value).join(', ');

      const formData = {
        name: document.getElementById('tripName').value,
        email: document.getElementById('tripEmail').value,
        phone: document.getElementById('tripPhone').value,
        departureDate: document.getElementById('departureDate').value,
        visitedBefore: document.getElementById('visitedBefore').value,
        interests: interests || 'None selected',
        additionalInfo: document.getElementById('additionalInfo').value,
        howDidYouHear: document.getElementById('howDidYouHear').value
      };

      try {
        const response = await fetch(TRIP_PLANNER_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        // Show success message
        formMessage.className = 'text-center p-4 rounded-lg bg-green-50 border border-green-200 text-green-800 font-medium';
        formMessage.innerHTML = '✓ Request submitted successfully!<br>We\'ll contact you within 24 hours to plan your perfect Bhutan journey.';
        formMessage.classList.remove('hidden');

        // Reset form
        document.getElementById('tripPlannerForm').reset();

        // Close modal after 3 seconds
        setTimeout(function() {
          closeModal();
          formMessage.classList.add('hidden');
        }, 3000);

      } catch (error) {
        // Show error message
        formMessage.className = 'text-center p-4 rounded-lg bg-red-50 border border-red-200 text-red-800 font-medium';
        formMessage.innerHTML = '✗ Something went wrong.<br>Please try again or contact us directly.';
        formMessage.classList.remove('hidden');
      }

      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    });
  }
</script>